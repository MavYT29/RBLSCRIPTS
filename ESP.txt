--[[
   SIMPLE ESP WITH F6 TOGGLE
   Press F6 to turn ESP ON/OFF
   Features:
   - Team ESP (Blue)
   - Enemy ESP (Red)
   - Clean Name Tags
   - Distance Display
   - Simple Box ESP
   - F6 Toggle
--]]

-- CONFIGURATION
local Settings = {
    TeamColor = Color3.fromRGB(0, 120, 255),    -- Blue for teammates
    EnemyColor = Color3.fromRGB(255, 50, 50),   -- Red for enemies
    TextColor = Color3.fromRGB(255, 255, 255),  -- White text
    BoxTransparency = 0.7,                      -- Box transparency
    ShowNames = true,                           -- Show player names
    ShowDistance = true,                        -- Show distance
    ShowBoxes = true,                           -- Show box ESP
    MaxDistance = 1000,                         -- Maximum render distance
    TextSize = 14,                              -- Text size
    Font = Enum.Font.GothamBold,                -- Font style
    ESPEnabled = true                           -- ESP initially enabled
}

-- SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ESP CONTAINER
local ESPFolder = Instance.new("Folder")
ESPFolder.Name = "SimpleESP"
ESPFolder.Parent = game.CoreGui

-- STORAGE
local ESPData = {}
local ESPConnections = {}

-- NOTIFICATION FUNCTION
local function ShowNotification(message, duration)
    duration = duration or 3
    
    -- Create notification GUI
    local screenGui = Instance.new("ScreenGui", game.CoreGui)
    screenGui.Name = "ESPNotification"
    
    local frame = Instance.new("Frame", screenGui)
    frame.Size = UDim2.new(0, 300, 0, 60)
    frame.Position = UDim2.new(0.5, -150, 0.1, 0)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner", frame)
    corner.CornerRadius = UDim.new(0, 8)
    
    local stroke = Instance.new("UIStroke", frame)
    stroke.Color = Color3.fromRGB(100, 100, 255)
    stroke.Thickness = 2
    
    local label = Instance.new("TextLabel", frame)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = message
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextSize = 18
    label.Font = Enum.Font.GothamBold
    label.TextStrokeTransparency = 0.5
    
    -- Animate
    frame.BackgroundTransparency = 1
    label.TextTransparency = 1
    
    local fadeIn = game:GetService("TweenService"):Create(frame, TweenInfo.new(0.3), {BackgroundTransparency = 0})
    local textFadeIn = game:GetService("TweenService"):Create(label, TweenInfo.new(0.3), {TextTransparency = 0})
    
    fadeIn:Play()
    textFadeIn:Play()
    
    fadeIn.Completed:Wait()
    
    wait(duration)
    
    local fadeOut = game:GetService("TweenService"):Create(frame, TweenInfo.new(0.3), {BackgroundTransparency = 1})
    local textFadeOut = game:GetService("TweenService"):Create(label, TweenInfo.new(0.3), {TextTransparency = 1})
    
    fadeOut:Play()
    textFadeOut:Play()
    
    fadeOut.Completed:Wait()
    screenGui:Destroy()
end

-- FUNCTION TO GET ESP COLOR
local function GetPlayerColor(player)
    if player == LocalPlayer then return nil end
    
    local localTeam = LocalPlayer.Team
    local playerTeam = player.Team
    
    if localTeam and playerTeam then
        if localTeam == playerTeam then
            return Settings.TeamColor  -- Teammate
        else
            return Settings.EnemyColor -- Enemy
        end
    end
    
    return Settings.EnemyColor -- Default to enemy if no teams
end

-- CREATE BOX ESP
local function CreateBoxESP(player, character)
    local box = Instance.new("BoxHandleAdornment")
    box.Name = player.Name .. "_Box"
    box.Size = Vector3.new(4, 6, 1)
    box.Color3 = GetPlayerColor(player)
    box.Transparency = Settings.BoxTransparency
    box.ZIndex = 1
    box.AlwaysOnTop = true
    box.Adornee = character
    box.Visible = Settings.ShowBoxes and Settings.ESPEnabled
    box.Parent = ESPFolder
    
    return box
end

-- CREATE NAME TAG
local function CreateNameTag(player, character)
    local head = character:WaitForChild("Head")
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = player.Name .. "_Tag"
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.AlwaysOnTop = true
    billboard.MaxDistance = Settings.MaxDistance
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.Adornee = head
    billboard.Enabled = Settings.ShowNames and Settings.ESPEnabled
    billboard.Parent = ESPFolder
    
    -- Background
    local background = Instance.new("Frame")
    background.Name = "Background"
    background.Size = UDim2.new(1, 0, 1, 0)
    background.BackgroundColor3 = Color3.new(0, 0, 0)
    background.BackgroundTransparency = 0.3
    background.BorderSizePixel = 0
    background.Parent = billboard
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 4)
    corner.Parent = background
    
    -- Name Label
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "Name"
    nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    nameLabel.Position = UDim2.new(0, 0, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = GetPlayerColor(player)
    nameLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    nameLabel.TextStrokeTransparency = 0.5
    nameLabel.TextSize = Settings.TextSize
    nameLabel.Font = Settings.Font
    nameLabel.Text = player.Name
    nameLabel.TextXAlignment = Enum.TextXAlignment.Center
    nameLabel.Parent = billboard
    
    -- Distance Label
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "Distance"
    distanceLabel.Size = UDim2.new(1, 0, 0.5, 0)
    distanceLabel.Position = UDim2.new(0, 0, 0.5, 0)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.TextColor3 = Settings.TextColor
    distanceLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
    distanceLabel.TextStrokeTransparency = 0.5
    distanceLabel.TextSize = Settings.TextSize - 2
    distanceLabel.Font = Settings.Font
    distanceLabel.Text = "Loading..."
    distanceLabel.TextXAlignment = Enum.TextXAlignment.Center
    distanceLabel.Visible = Settings.ShowDistance
    distanceLabel.Parent = billboard
    
    return {
        Billboard = billboard,
        NameLabel = nameLabel,
        DistanceLabel = distanceLabel
    }
end

-- UPDATE DISTANCE
local function UpdateDistance(player, distanceLabel)
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        return
    end
    
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local distance = (player.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
        distanceLabel.Text = string.format("[%d studs]", math.floor(distance))
        
        -- Hide if too far
        if distance > Settings.MaxDistance then
            distanceLabel.Visible = false
        else
            distanceLabel.Visible = Settings.ShowDistance and Settings.ESPEnabled
        end
    end
end

-- CREATE ESP FOR PLAYER
local function CreateESP(player)
    if player == LocalPlayer then return end
    
    local character = player.Character
    if not character then
        player.CharacterAdded:Wait()
        character = player.Character
    end
    
    character:WaitForChild("Humanoid")
    
    local espData = {}
    
    -- Create ESP elements
    if Settings.ShowBoxes then
        espData.Box = CreateBoxESP(player, character)
    end
    
    if Settings.ShowNames then
        espData.NameTag = CreateNameTag(player, character)
    end
    
    -- Store data
    ESPData[player] = espData
    
    -- Update loop
    local connection
    connection = RunService.Heartbeat:Connect(function()
        if not Settings.ESPEnabled then return end
        if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
            return
        end
        
        -- Update distance
        if espData.NameTag then
            UpdateDistance(player, espData.NameTag.DistanceLabel)
        end
        
        -- Update colors if team changed
        local newColor = GetPlayerColor(player)
        if espData.Box then
            espData.Box.Color3 = newColor
            espData.Box.Visible = Settings.ShowBoxes and Settings.ESPEnabled
        end
        if espData.NameTag then
            espData.NameTag.NameLabel.TextColor3 = newColor
            espData.NameTag.Billboard.Enabled = Settings.ShowNames and Settings.ESPEnabled
        end
    end)
    
    -- Store connection
    espData.Connection = connection
    
    return espData
end

-- REMOVE ESP FOR PLAYER
local function RemoveESP(player)
    if ESPData[player] then
        -- Disconnect update loop
        if ESPData[player].Connection then
            ESPData[player].Connection:Disconnect()
        end
        
        -- Clear all ESP elements
        for _, element in pairs(ESPData[player]) do
            if element and element.Parent then
                element:Destroy()
            end
        end
        
        ESPData[player] = nil
    end
end

-- TOGGLE ESP FUNCTION
local function ToggleESP()
    Settings.ESPEnabled = not Settings.ESPEnabled
    
    -- Update all ESP elements
    for player, espData in pairs(ESPData) do
        if espData.Box then
            espData.Box.Visible = Settings.ShowBoxes and Settings.ESPEnabled
        end
        if espData.NameTag then
            espData.NameTag.Billboard.Enabled = Settings.ShowNames and Settings.ESPEnabled
            if espData.NameTag.DistanceLabel then
                espData.NameTag.DistanceLabel.Visible = Settings.ShowDistance and Settings.ESPEnabled
            end
        end
    end
    
    -- Show notification
    local status = Settings.ESPEnabled and "ENABLED" or "DISABLED"
    local color = Settings.ESPEnabled and "ðŸŸ¢" or "ðŸ”´"
    ShowNotification(color .. " ESP " .. status, 2)
    
    print("ESP " .. (Settings.ESPEnabled and "Enabled" or "Disabled"))
end

-- INITIALIZE ALL PLAYERS
local function InitializePlayers()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            spawn(function()
                pcall(CreateESP, player)
            end)
        end
    end
end

-- F6 KEYBIND
local F6Pressed = false
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if input.KeyCode == Enum.KeyCode.F6 then
        if not F6Pressed then
            F6Pressed = true
            ToggleESP()
            
            -- Debounce
            wait(0.3)
            F6Pressed = false
        end
    end
end)

-- PLAYER ADDED
Players.PlayerAdded:Connect(function(player)
    local charAddedConn
    charAddedConn = player.CharacterAdded:Connect(function()
        wait(0.5) -- Small delay for character to fully load
        pcall(function()
            CreateESP(player)
        end)
    end)
    
    -- Store connection
    table.insert(ESPConnections, charAddedConn)
end)

-- PLAYER REMOVING
Players.PlayerRemoving:Connect(function(player)
    pcall(function()
        RemoveESP(player)
    end)
end)

-- CHARACTER REMOVED
LocalPlayer.CharacterRemoving:Connect(function()
    -- Clean up all ESP when local player dies
    for player in pairs(ESPData) do
        RemoveESP(player)
    end
    ESPData = {}
end)

-- TEAM CHANGED
local function HandleTeamChange(player)
    if ESPData[player] then
        local color = GetPlayerColor(player)
        
        if ESPData[player].Box then
            ESPData[player].Box.Color3 = color
        end
        
        if ESPData[player].NameTag then
            ESPData[player].NameTag.NameLabel.TextColor3 = color
        end
    end
end

-- CONNECT TEAM CHANGE EVENTS
for _, player in ipairs(Players:GetPlayers()) do
    local teamConn = player:GetPropertyChangedSignal("Team"):Connect(function()
        HandleTeamChange(player)
    end)
    table.insert(ESPConnections, teamConn)
end

Players.PlayerAdded:Connect(function(player)
    local teamConn = player:GetPropertyChangedSignal("Team"):Connect(function()
        HandleTeamChange(player)
    end)
    table.insert(ESPConnections, teamConn)
end)

-- CLEANUP FUNCTION
local function CleanupESP()
    -- Remove all ESP elements
    for player in pairs(ESPData) do
        RemoveESP(player)
    end
    
    -- Disconnect all connections
    for _, conn in ipairs(ESPConnections) do
        if conn then
            conn:Disconnect()
        end
    end
    
    -- Clear folder
    ESPFolder:Destroy()
    
    print("ESP Cleaned Up")
end

-- AUTO INITIALIZE
wait(2) -- Wait for game to fully load
InitializePlayers()

-- INITIAL NOTIFICATION
spawn(function()
    wait(1)
    ShowNotification("ESP LOADED\nPress F6 to toggle", 3)
end)

-- CREATE SIMPLE UI INDICATOR
spawn(function()
    local indicatorGui = Instance.new("ScreenGui", game.CoreGui)
    indicatorGui.Name = "ESPIndicator"
    indicatorGui.ResetOnSpawn = false
    
    local indicator = Instance.new("Frame", indicatorGui)
    indicator.Size = UDim2.new(0, 120, 0, 30)
    indicator.Position = UDim2.new(1, -130, 0, 10)
    indicator.BackgroundColor3 = Settings.ESPEnabled and Color3.fromRGB(0, 100, 0) or Color3.fromRGB(100, 0, 0)
    indicator.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner", indicator)
    corner.CornerRadius = UDim.new(0, 6)
    
    local stroke = Instance.new("UIStroke", indicator)
    stroke.Color = Color3.fromRGB(255, 255, 255)
    stroke.Thickness = 2
    
    local label = Instance.new("TextLabel", indicator)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = "ESP: " .. (Settings.ESPEnabled and "ON" or "OFF")
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextSize = 14
    label.Font = Enum.Font.GothamBold
    
    -- Update indicator when ESP is toggled
    while true do
        indicator.BackgroundColor3 = Settings.ESPEnabled and Color3.fromRGB(0, 100, 0) or Color3.fromRGB(100, 0, 0)
        label.Text = "ESP: " .. (Settings.ESPEnabled and "ON" or "OFF")
        wait(0.1)
    end
end)
